<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatório de Serviços - Victorino</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel para compilar JSX no navegador -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Estilos globais e de Impressão -->
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        /* Remove setas dos inputs numéricos */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        /* === ESTILOS DE IMPRESSÃO (RELATÓRIO MELHORADO) === */
        @media print {
            body { background-color: white; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .no-print { display: none !important; } /* Esconde botões */
            .shadow-sm, .shadow-lg, .border { box-shadow: none !important; border-color: #000 !important; }
            .bg-gray-100 { background-color: white !important; }
            .text-white { color: black !important; }
            
            /* Layout Flexível na Impressão para reordenar */
            .max-w-7xl { max-width: 100% !important; margin: 0 !important; padding: 0 !important; }
            
            /* Transforma o Grid em Flex Coluna para respeitar 'order-1' e 'order-2' */
            .grid { 
                display: flex !important; 
                flex-direction: column !important; 
                gap: 20px !important;
            }
            
            /* Tabela de Serviços (order-1) vai para o topo */
            /* Sidebar (order-2) vai para baixo */
            
            /* Garante largura total */
            .lg\:col-span-3, .flex-col { width: 100% !important; }
            
            /* Estilos da Tabela */
            table { width: 100% !important; font-size: 11pt !important; border-collapse: collapse !important; }
            th, td { padding: 6px !important; border: 1px solid #333 !important; }
            
            /* Inputs mais limpos na impressão */
            input { font-weight: bold !important; color: #000 !important; background: transparent !important; }
            input[type="date"]::-webkit-calendar-picker-indicator { display: none; }

            /* Força cores de fundo */
            .bg-\[\#FFE699\] { background-color: #FFE699 !important; }
            .bg-\[\#D9E1F2\] { background-color: #D9E1F2 !important; }
            .bg-\[\#00B0F0\] { background-color: #00B0F0 !important; color: black !important; font-weight: bold; }
            .bg-\[\#FFFF00\] { background-color: #FFFF00 !important; }
            .bg-\[\#D9D9D9\] { background-color: #D9D9D9 !important; }
            
            /* Evita quebrar o Resumo Financeiro no meio */
            .print-break-inside-avoid { page-break-inside: avoid; break-inside: avoid; margin-top: 20px; }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="root"></div>

    <!-- Script Principal da Aplicação -->
    <script type="text/babel" data-type="module">
        // Importações do React globais
        const { useState, useEffect, useMemo } = React;

        // --- Ícones SVG ---
        const Icon = ({ children, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {children}
            </svg>
        );

        const CalendarIcon = ({ className }) => <Icon className={className}><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></Icon>;
        const ChevronLeft = ({ className }) => <Icon className={className}><polyline points="15 18 9 12 15 6"/></Icon>;
        const ChevronRight = ({ className }) => <Icon className={className}><polyline points="9 18 15 12 9 6"/></Icon>;
        const Plus = ({ className }) => <Icon className={className}><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></Icon>;
        const Trash2 = ({ className }) => <Icon className={className}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></Icon>;
        const LogOut = ({ className }) => <Icon className={className}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></Icon>;
        const Lock = ({ className }) => <Icon className={className}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></Icon>;
        const ShieldAlert = ({ className }) => <Icon className={className}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></Icon>;
        const Printer = ({ className }) => <Icon className={className}><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></Icon>;

        // --- Módulos do Firebase via CDN (Versão Compatível) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { 
            getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, 
            onSnapshot, query, where, getDocs, writeBatch, serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // =================================================================================
        // SUAS CHAVES DO FIREBASE
        // =================================================================================
        
        const firebaseConfig = {
            apiKey: "AIzaSyAAbRqZjFI8XgPcSihtLL8OMr5snNp3ts4",
            authDomain: "serviextra-ecdc7.firebaseapp.com",
            projectId: "serviextra-ecdc7",
            storageBucket: "serviextra-ecdc7.firebasestorage.app",
            messagingSenderId: "892522606172",
            appId: "1:892522606172:web:e5393e632559ae7d404099"
        };
        
        // =================================================================================

        // Inicialização
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Erro ao inicializar Firebase", e);
        }

        const APP_ID = 'meu-registro-servicos'; 

        // --- TELA DE LOGIN ---
        function LoginScreen() {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loggingIn, setLoggingIn] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');
                setLoggingIn(true);
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (err) {
                    console.error("Erro login:", err);
                    let msg = "Erro ao fazer login.";
                    if (err.code === 'auth/invalid-credential' || err.code === 'auth/wrong-password') msg = "E-mail ou senha incorretos.";
                    else if (err.code === 'auth/too-many-requests') msg = "Muitas tentativas. Aguarde um instante.";
                    else if (err.code === 'auth/user-not-found') msg = "Usuário não encontrado.";
                    setError(msg);
                    setLoggingIn(false);
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-gray-200 p-4">
                    <div className="bg-white p-8 rounded-xl shadow-lg w-full max-w-sm border border-gray-100">
                        <div className="text-center mb-6">
                            <div className="bg-blue-100 w-14 h-14 rounded-full flex items-center justify-center mx-auto mb-3">
                                <Lock className="w-6 h-6 text-blue-600" />
                            </div>
                            <h2 className="text-xl font-bold text-gray-800">Controle de Serviços</h2>
                            <p className="text-gray-500 text-sm mt-1">Acesso Restrito</p>
                        </div>
                        
                        <form onSubmit={handleSubmit} className="space-y-4">
                            {error && <div className="bg-red-50 text-red-600 p-3 rounded text-xs text-center border border-red-100">{error}</div>}
                            <div>
                                <label className="block text-xs font-bold text-gray-700 uppercase mb-1">E-mail</label>
                                <input type="email" required value={email} onChange={(e) => setEmail(e.target.value)} className="w-full p-2 border border-gray-300 rounded focus:border-blue-500 outline-none" placeholder="seu@email.com" />
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-gray-700 uppercase mb-1">Senha</label>
                                <input type="password" required value={password} onChange={(e) => setPassword(e.target.value)} className="w-full p-2 border border-gray-300 rounded focus:border-blue-500 outline-none" placeholder="******" />
                            </div>
                            <button type="submit" disabled={loggingIn} className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded transition-colors disabled:opacity-70">
                                {loggingIn ? 'Entrando...' : 'Entrar'}
                            </button>
                        </form>
                    </div>
                </div>
            );
        }

        // --- APLICAÇÃO PRINCIPAL ---
        function ServiceRegistryApp() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [permissionError, setPermissionError] = useState(false);
            const [selectedDate, setSelectedDate] = useState(new Date(2025, 8, 1)); // Setembro 2025

            // Dados
            const [services, setServices] = useState([]);
            const [deposits, setDeposits] = useState([]);

            // Autenticação
            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
                    setUser(currentUser);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            // Preenchimento Automático Inicial (Demo)
            useEffect(() => {
                if (!user || !db || permissionError) return;
                const populate = async () => {
                    const batch = writeBatch(db);
                    let hasUpdates = false;

                    // SETEMBRO 2025 (Demo)
                    const sRef = collection(db, 'apps', APP_ID, 'users', user.uid, 'services');
                    const qSet = query(sRef, where('date', '==', '2025-09-22'));
                    const snapSet = await getDocs(qSet);

                    if (snapSet.empty) {
                        hasUpdates = true;
                        const dRef = collection(db, 'apps', APP_ID, 'users', user.uid, 'deposits');
                        const newDeposit = doc(dRef);
                        batch.set(newDeposit, { date: '2025-09-01', amount: 3622.97, description: 'SALDO MÊS DE AGOSTO', type: 'manual_initial', createdAt: serverTimestamp() });

                        const servicesSet = [
                            { date: '2025-09-22', value: 200, paidValue: 200, status: 'CONCLUÍDO' },
                            { date: '2025-09-26', value: 200, paidValue: 200, status: 'CONCLUÍDO' },
                        ];
                        servicesSet.forEach(d => {
                            const newService = doc(sRef);
                            batch.set(newService, { ...d, description: 'Serviço', createdAt: serverTimestamp() });
                        });
                    }

                    // OUTUBRO 2025 (Demo)
                    const qOut = query(sRef, where('date', '==', '2025-10-04'));
                    const snapOut = await getDocs(qOut);

                    if (snapOut.empty) {
                        hasUpdates = true;
                        const servicesOut = [
                            { date: '2025-10-04', value: 200, paidValue: 200, status: 'CONCLUÍDO' },
                            { date: '2025-10-06', value: 200, paidValue: 200, status: 'CONCLUÍDO' },
                            { date: '2025-10-08', value: 200, paidValue: 200, status: 'CONCLUÍDO' },
                            { date: '2025-10-14', value: 200, paidValue: 200, status: 'CONCLUÍDO' },
                        ];
                        servicesOut.forEach(d => {
                            const newService = doc(sRef);
                            batch.set(newService, { ...d, description: 'Serviço', createdAt: serverTimestamp() });
                        });
                    }

                    if (hasUpdates) {
                        try { await batch.commit(); } 
                        catch(e) { if(e.code === 'permission-denied') setPermissionError(true); }
                    }
                };
                populate();
            }, [user, permissionError]);

            // Listeners em Tempo Real
            useEffect(() => {
                if (!user || !db) return;
                const qS = query(collection(db, 'apps', APP_ID, 'users', user.uid, 'services'));
                const unsubS = onSnapshot(qS, (snap) => setServices(snap.docs.map(d => ({id: d.id, ...d.data()}))), (e) => {if(e.code==='permission-denied')setPermissionError(true)});
                const qD = query(collection(db, 'apps', APP_ID, 'users', user.uid, 'deposits'));
                const unsubD = onSnapshot(qD, (snap) => setDeposits(snap.docs.map(d => ({id: d.id, ...d.data()}))), (e) => {if(e.code==='permission-denied')setPermissionError(true)});
                return () => { unsubS(); unsubD(); };
            }, [user]);

            // === LÓGICA DE SALDO MÊS ANTERIOR (Automático) ===
            useEffect(() => {
                if (!user || loading || services.length === 0) return;

                const checkAndCreateBalance = async () => {
                    const prevDate = new Date(selectedDate);
                    prevDate.setMonth(selectedDate.getMonth() - 1);
                    
                    const pServices = services.filter(s => {
                        const d = new Date(s.date + 'T12:00:00');
                        return d.getMonth() === prevDate.getMonth() && d.getFullYear() === prevDate.getFullYear();
                    });
                    const pDeposits = deposits.filter(d => {
                        const dDate = new Date(d.date + 'T12:00:00');
                        return dDate.getMonth() === prevDate.getMonth() && dDate.getFullYear() === prevDate.getFullYear();
                    });

                    if (pServices.length === 0 && pDeposits.length === 0) return;

                    const pPaid = pServices.reduce((acc, c) => acc + (Number(c.paidValue)||0), 0);
                    const pDepTotal = pDeposits.reduce((acc, c) => acc + (Number(c.amount)||0), 0);
                    const prevBalance = pDepTotal - pPaid;

                    const prevMonthName = prevDate.toLocaleDateString('pt-BR', { month: 'long' }).toUpperCase();
                    const expectedDesc = `SALDO MÊS DE ${prevMonthName}`;
                    
                    const cDeposits = deposits.filter(d => {
                        const dDate = new Date(d.date + 'T12:00:00');
                        return dDate.getMonth() === selectedDate.getMonth() && dDate.getFullYear() === selectedDate.getFullYear();
                    });

                    const existingEntry = cDeposits.find(d => d.description === expectedDesc || d.type === 'balance_carryover');

                    try {
                        if (existingEntry) {
                            if (Math.abs((existingEntry.amount || 0) - prevBalance) > 0.01) {
                                await updateDoc(doc(db, 'apps', APP_ID, 'users', user.uid, 'deposits', existingEntry.id), {
                                    amount: prevBalance, description: expectedDesc, type: 'balance_carryover'
                                });
                            }
                        } else {
                            const newDateStr = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), 1, 12).toISOString().split('T')[0];
                            await addDoc(collection(db, 'apps', APP_ID, 'users', user.uid, 'deposits'), {
                                date: newDateStr, amount: prevBalance, description: expectedDesc, type: 'balance_carryover', createdAt: serverTimestamp()
                            });
                        }
                    } catch (e) { if(e.code === 'permission-denied') setPermissionError(true); }
                };
                checkAndCreateBalance();
            }, [selectedDate, services, deposits]); 

            // Cálculos Totais
            const currentServices = useMemo(() => services.filter(s => {
                if(!s.date) return false;
                const d = new Date(s.date + 'T12:00:00');
                return d.getMonth() === selectedDate.getMonth() && d.getFullYear() === selectedDate.getFullYear();
            }).sort((a,b) => new Date(a.date) - new Date(b.date)), [services, selectedDate]);

            const currentDeposits = useMemo(() => deposits.filter(d => {
                if(!d.date) return false;
                const date = new Date(d.date + 'T12:00:00');
                return date.getMonth() === selectedDate.getMonth() && date.getFullYear() === selectedDate.getFullYear();
            }), [deposits, selectedDate]);

            const totals = useMemo(() => {
                const prog = currentServices.reduce((acc, c) => acc + (Number(c.value)||0), 0);
                const paid = currentServices.reduce((acc, c) => acc + (Number(c.paidValue)||0), 0);
                const done = currentServices.filter(s => s.status === 'CONCLUÍDO').length;
                const remaining = currentServices.length - done;
                const depTotal = currentDeposits.reduce((acc, c) => acc + (Number(c.amount)||0), 0);
                const saldo = depTotal - prog; // Saldo = Depósitos - Programado
                return { prog, paid, done, remaining, depTotal, saldo };
            }, [currentServices, currentDeposits]);

            // Ações
            const handleLogout = () => confirm("Sair do sistema?") && signOut(auth);
            const handlePrint = () => window.print(); // Função simples de imprimir
            const changeMonth = (offset) => {
                const d = new Date(selectedDate);
                d.setMonth(d.getMonth() + offset);
                setSelectedDate(d);
            };
            const addService = async () => {
                const today = new Date();
                let d = today.toISOString().split('T')[0];
                if(today.getMonth() !== selectedDate.getMonth()) { d = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), 1, 12).toISOString().split('T')[0]; }
                try { await addDoc(collection(db, 'apps', APP_ID, 'users', user.uid, 'services'), { date: d, value: 0, paidValue: 0, status: 'PENDENTE', createdAt: serverTimestamp() }); } catch(e) { if(e.code==='permission-denied')setPermissionError(true); }
            };
            const updService = async (id, f, v) => { try { await updateDoc(doc(db, 'apps', APP_ID, 'users', user.uid, 'services', id), {[f]:v}); } catch(e) { if(e.code==='permission-denied')setPermissionError(true); } };
            const delService = async (id) => { if(confirm("Excluir?")) { try { await deleteDoc(doc(db, 'apps', APP_ID, 'users', user.uid, 'services', id)); } catch(e) { if(e.code==='permission-denied')setPermissionError(true); } } };
            const addDeposit = async () => { const d = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), 1, 12).toISOString().split('T')[0]; try { await addDoc(collection(db, 'apps', APP_ID, 'users', user.uid, 'deposits'), { date: d, amount: 0, createdAt: serverTimestamp() }); } catch(e) { if(e.code==='permission-denied')setPermissionError(true); } };
            const updDeposit = async (id, f, v) => { try { await updateDoc(doc(db, 'apps', APP_ID, 'users', user.uid, 'deposits', id), {[f]:v}); } catch(e) { if(e.code==='permission-denied')setPermissionError(true); } };
            const delDeposit = async (id) => { if(confirm("Excluir?")) { try { await deleteDoc(doc(db, 'apps', APP_ID, 'users', user.uid, 'deposits', id)); } catch(e) { if(e.code==='permission-denied')setPermissionError(true); } } };

            const format = (v) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v);
            const getDay = (ds) => ds ? ['DOMINGO','SEGUNDA','TERÇA','QUARTA','QUINTA','SEXTA','SÁBADO'][new Date(ds+'T12:00:00').getDay()] : '-';

            // Cores
            const hY = "bg-[#FFE699]"; 
            const hB = "bg-[#D9E1F2]";
            const cC = "bg-[#00B0F0]";
            const cB = "text-[#0070C0]";
            const sY = "bg-[#FFFF00]";
            const sG = "bg-[#D9D9D9]";

            if (loading) return <div className="flex items-center justify-center h-screen bg-gray-50 text-gray-500">Carregando...</div>;
            if (!user) return <LoginScreen />;

            if (permissionError) return (
                <div className="min-h-screen flex items-center justify-center bg-gray-800 p-4">
                    <div className="bg-white p-8 rounded-xl shadow-2xl w-full max-w-2xl border border-red-500">
                        <div className="flex items-center gap-3 mb-6 text-red-600"><ShieldAlert className="w-10 h-10" /><h2 className="text-2xl font-bold">Banco de Dados Bloqueado</h2></div>
                        <p className="mb-4 text-gray-700">O Firebase está bloqueando o acesso aos seus dados por segurança. Adicione as regras no console.</p>
                        <button onClick={() => window.location.reload()} className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg">Tentar novamente</button>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen bg-gray-100 p-2 md:p-4 font-sans text-sm md:text-base">
                    {/* Header */}
                    <div className="max-w-7xl mx-auto mb-6 flex flex-col md:flex-row justify-between items-center gap-4 bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                        <h1 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                            <CalendarIcon className="w-6 h-6 text-blue-600" /> Registro de Serviços
                        </h1>
                        <div className="flex items-center gap-4 bg-gray-50 p-2 rounded-lg border border-gray-200 no-print">
                            <button onClick={() => changeMonth(-1)} className="p-2 hover:bg-gray-200 rounded-full transition-colors"><ChevronLeft className="w-5 h-5 text-gray-600" /></button>
                            <div className="text-lg font-bold text-gray-800 w-40 text-center uppercase">{selectedDate.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' })}</div>
                            <button onClick={() => changeMonth(1)} className="p-2 hover:bg-gray-200 rounded-full transition-colors"><ChevronRight className="w-5 h-5 text-gray-600" /></button>
                        </div>
                        <div className="flex gap-2 no-print">
                            <button onClick={handlePrint} className="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 font-medium shadow-sm"><Printer className="w-4 h-4" /> Gerar Relatório</button>
                            <button onClick={addService} className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 font-medium shadow-sm"><Plus className="w-4 h-4" /> Novo Serviço</button>
                            <button onClick={handleLogout} className="bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-2 rounded-lg shadow-sm" title="Sair"><LogOut className="w-4 h-4" /></button>
                        </div>
                        {/* Data visível apenas no relatório impresso */}
                        <div className="hidden print:block text-lg font-bold uppercase text-center mb-4">{selectedDate.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' })}</div>
                    </div>

                    {/* Grid Principal */}
                    <div className="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-4 gap-6">
                        
                        {/* 1. Sidebar (ESQUERDA) */}
                        <div className="flex flex-col gap-6 order-2 lg:order-1">
                            {/* Resumo Financeiro */}
                            <div className="bg-white p-4 rounded-lg shadow-sm border border-gray-200 print-break-inside-avoid">
                                <h3 className="text-sm font-bold text-gray-500 mb-3 uppercase tracking-wider border-b pb-2">Resumo Financeiro</h3>
                                <div className="border border-gray-800 text-center font-bold text-sm">
                                    <div className="grid grid-cols-2 border-b border-gray-800"><div className={`${sY} p-2 border-r border-gray-800 flex items-center justify-center`}>SERV. PROGRAMADOS</div><div className={`${sG} p-2 flex items-center justify-center text-lg`}>{format(totals.prog)}</div></div>
                                    <div className="grid grid-cols-2 border-b border-gray-800"><div className={`${sY} p-2 border-r border-gray-800 flex items-center justify-center`}>TOTAL PAGO</div><div className={`${sG} p-2 flex items-center justify-center text-lg`}>{format(totals.depTotal)}</div></div>
                                    <div className="grid grid-cols-2 border-b border-gray-800"><div className={`${sY} p-2 border-r border-gray-800 flex items-center justify-center`}>CONCLUÍDOS</div><div className={`${sG} p-2 flex items-center justify-center text-lg`}>{totals.done}</div></div>
                                    <div className="grid grid-cols-2 border-b border-gray-800"><div className={`${sY} p-2 border-r border-gray-800 flex items-center justify-center`}>SERVIÇOS RESTANTES</div><div className={`${sG} p-2 flex items-center justify-center text-lg`}>{totals.remaining}</div></div>
                                    <div className="grid grid-cols-2"><div className={`${sY} p-2 border-r border-gray-800 flex items-center justify-center`}>SALDO</div><div className={`${sG} p-2 flex items-center justify-center text-lg text-gray-800`}>{format(totals.saldo)}</div></div>
                                </div>
                            </div>

                            {/* Tabela de Depósitos */}
                            <div className="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden print-break-inside-avoid">
                                <div className="flex justify-between items-center p-3 bg-gray-50 border-b border-gray-200">
                                    <h3 className="font-bold text-gray-700 text-sm uppercase">Depósitos</h3>
                                    <button onClick={addDeposit} className="text-blue-600 hover:text-blue-800 no-print"><Plus className="w-4 h-4" /></button>
                                </div>
                                <table className="w-full text-sm">
                                    <thead className="bg-yellow-100 text-yellow-800 font-bold"><tr><th className="p-2 text-left">Data / Desc</th><th className="p-2 text-right">Valor</th><th className="w-6 no-print"></th></tr></thead>
                                    <tbody className="divide-y divide-gray-100">
                                        {currentDeposits.map(d => (
                                            <tr key={d.id} className="hover:bg-gray-50">
                                                <td className="p-2">
                                                    <input type="text" value={d.description||''} onChange={e=>updDeposit(d.id,'description',e.target.value)} placeholder="Desc." className="w-full bg-transparent font-bold uppercase text-xs mb-1 outline-none" />
                                                    <input type="date" value={d.date} onChange={e=>updDeposit(d.id,'date',e.target.value)} className="w-full bg-transparent text-gray-500 text-xs outline-none" />
                                                </td>
                                                <td className="p-2 text-right font-bold text-green-700 align-top">
                                                    <div className="flex justify-end gap-1"><span className="text-xs text-gray-400">R$</span><input type="number" step="0.01" value={d.amount} onChange={e=>updDeposit(d.id,'amount',parseFloat(e.target.value))} className="w-16 text-right bg-transparent outline-none" /></div>
                                                </td>
                                                <td className="p-2 align-top no-print"><button onClick={()=>delDeposit(d.id)} className="text-gray-400 hover:text-red-500"><Trash2 className="w-3 h-3" /></button></td>
                                            </tr>
                                        ))}
                                    </tbody>
                                    <tfoot className="bg-gray-50 font-bold text-gray-700 text-xs"><tr><td className="p-2 text-right">TOTAL:</td><td className="p-2 text-right">{format(totals.depTotal)}</td><td className="no-print"></td></tr></tfoot>
                                </table>
                            </div>
                        </div>

                        {/* 2. Tabela Principal (DIREITA) */}
                        <div className="lg:col-span-3 bg-white rounded-lg shadow-sm overflow-hidden border border-gray-300 order-1 lg:order-2">
                            <div className="overflow-x-auto">
                                <table className="w-full border-collapse min-w-[800px]">
                                    <thead>
                                        <tr>
                                            <th className={`border border-gray-400 p-2 w-16 text-center font-bold ${hY}`}>{currentServices.length} <br/> <span className="text-xs font-normal">DIAS</span></th>
                                            <th className={`border border-gray-400 p-2 text-center font-bold ${hY}`}>SERVIÇOS <br/> <span className="text-xs font-normal">SEMANA</span></th>
                                            <th colSpan="6" className={`border border-gray-400 p-2 text-center font-bold ${hB} text-lg uppercase`}>CONTROLE MENSAL - {user?.email?.split('@')[0]}</th>
                                        </tr>
                                        <tr className="text-xs md:text-sm uppercase bg-[#E2EFDA]">
                                            <th className="border border-gray-400 p-2 w-32">STATUS</th>
                                            <th className="border border-gray-400 p-2 w-32">DATA</th>
                                            <th className="border border-gray-400 p-2 w-28">DIA</th>
                                            <th className="border border-gray-400 p-2 w-32">VALOR (R$)</th>
                                            <th className="border border-gray-400 p-2 w-32">A PAGAR</th>
                                            <th className="border border-gray-400 p-2 w-32">PAGO</th>
                                            <th className="border border-gray-400 p-2 w-24">CONDIÇÃO</th>
                                            <th className="border border-gray-400 p-2 w-10 no-print"></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {currentServices.map(s => {
                                            const toPay = (Number(s.value)||0) - (Number(s.paidValue)||0);
                                            const isOk = s.status === 'CONCLUÍDO';
                                            return (
                                                <tr key={s.id} className="hover:bg-gray-50 text-sm font-medium">
                                                    <td className="border border-gray-300 p-0">
                                                        <button onClick={()=>updService(s.id,'status',s.status==='CONCLUÍDO'?'PENDENTE':'CONCLUÍDO')} className={`w-full h-full p-2 text-white font-bold uppercase text-xs ${s.status==='CONCLUÍDO'?cC:'bg-gray-400'}`}>{s.status||'PENDENTE'}</button>
                                                    </td>
                                                    <td className="border border-gray-300 p-1"><input type="date" value={s.date} onChange={e=>updService(s.id,'date',e.target.value)} className="w-full text-center font-bold uppercase bg-transparent outline-none" /></td>
                                                    <td className="border border-gray-300 p-2 text-center uppercase text-gray-700 font-bold bg-gray-50">{getDay(s.date)}</td>
                                                    <td className="border border-gray-300 p-1"><div className="flex px-2"><span className="text-gray-500 mr-1">R$</span><input type="number" step="0.01" value={s.value} onChange={e=>updService(s.id,'value',parseFloat(e.target.value))} className="w-full font-bold text-gray-800 outline-none" /></div></td>
                                                    <td className="border border-gray-300 p-2 text-center font-bold text-red-500 bg-gray-50">{toPay>0?format(toPay):<span className="text-gray-400">R$ -</span>}</td>
                                                    <td className="border border-gray-300 p-1"><div className="flex px-2"><span className="text-gray-500 mr-1">R$</span><input type="number" step="0.01" value={s.paidValue} onChange={e=>updService(s.id,'paidValue',parseFloat(e.target.value))} className={`w-full font-bold ${cB} outline-none`} /></div></td>
                                                    <td className="border border-gray-300 p-0 align-middle"><div className={`h-full flex items-center justify-center font-bold text-xs p-2 ${isOk ? cC+' text-white' : 'bg-yellow-100 text-yellow-700'}`}>{isOk ? 'OK' : 'ABERTO'}</div></td>
                                                    <td className="border border-gray-300 p-0 text-center no-print"><button onClick={()=>delService(s.id)} className="p-2 text-red-400 hover:text-red-600 hover:bg-red-50 w-full h-full flex items-center justify-center"><Trash2 className="w-4 h-4" /></button></td>
                                                </tr>
                                            );
                                        })}
                                        {currentServices.length===0 && <tr><td colSpan="8" className="p-8 text-center text-gray-400">Nenhum serviço neste mês.</td></tr>}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div className="text-center text-xs text-gray-400 mt-8 pb-4 no-print">Dados salvos automaticamente no Firebase.</div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ServiceRegistryApp />);
    </script>
</body>
</html>
