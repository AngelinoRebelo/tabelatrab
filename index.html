<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatório de Serviços - Victorino</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel para compilar JSX no navegador -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Estilos globais e de Impressão -->
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        /* Remove setas dos inputs numéricos */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        /* Barra de rolagem customizada para as abas */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        /* === ESTILOS DE IMPRESSÃO (OTIMIZADO) === */
        @media print {
            @page { size: landscape; margin: 5mm; }
            
            body { 
                background-color: white; 
                -webkit-print-color-adjust: exact; 
                print-color-adjust: exact;
                zoom: 90%; 
            }

            .no-print { display: none !important; } 
            .shadow-sm, .shadow-lg { box-shadow: none !important; }
            
            /* CORREÇÃO DAS BORDAS NA IMPRESSÃO */
            .border-gray-800, .border-gray-400, .border-gray-300, .border-gray-200 { 
                border-color: #000 !important; 
                border-style: solid !important;
            }
            
            .border { border-width: 1px !important; border-color: #000 !important; }
            .border-b { border-bottom-width: 1px !important; border-color: #000 !important; }
            .border-r { border-right-width: 1px !important; border-color: #000 !important; }

            .bg-gray-100 { background-color: white !important; }
            .text-white { color: black !important; }
            
            .max-w-7xl { max-width: 100% !important; margin: 0 !important; padding: 0 !important; }
            
            /* Grid Principal */
            .grid.lg\:grid-cols-4 { 
                display: grid !important; 
                grid-template-columns: 320px 1fr !important; 
                gap: 20px !important;
                align-items: start !important;
            }
            
            /* Grid do Resumo Financeiro */
            .grid.grid-cols-2 {
                display: grid !important;
                grid-template-columns: 1fr 1fr !important;
                width: 100% !important;
            }
            
            /* Reordenação visual */
            .order-1 { order: 2 !important; } 
            .order-2 { order: 1 !important; } 
            
            table { width: 100% !important; font-size: 10pt !important; border-collapse: collapse !important; }
            th, td { padding: 4px !important; border: 1px solid #444 !important; }
            
            input { font-weight: bold !important; color: #000 !important; background: transparent !important; border: none !important; padding: 0 !important; margin: 0 !important; width: 100%; text-align: inherit; }
            input[type="date"]::-webkit-calendar-picker-indicator { display: none; }

            .bg-\[\#FFE699\] { background-color: #FFE699 !important; }
            .bg-\[\#D9E1F2\] { background-color: #D9E1F2 !important; }
            .bg-\[\#00B0F0\] { background-color: #00B0F0 !important; color: black !important; font-weight: bold; }
            .bg-\[\#FFFF00\] { background-color: #FFFF00 !important; }
            .bg-\[\#D9D9D9\] { background-color: #D9D9D9 !important; }
            
            .overflow-hidden { overflow: visible !important; }
            .overflow-x-auto { overflow: visible !important; }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="root"></div>

    <!-- Script Principal da Aplicação -->
    <script type="text/babel" data-type="module">
        const { useState, useEffect, useMemo } = React;

        // --- Ícones SVG ---
        const Icon = ({ children, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );
        const CalendarIcon = ({ className }) => <Icon className={className}><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></Icon>;
        const ChevronLeft = ({ className }) => <Icon className={className}><polyline points="15 18 9 12 15 6"/></Icon>;
        const ChevronRight = ({ className }) => <Icon className={className}><polyline points="9 18 15 12 9 6"/></Icon>;
        const Plus = ({ className }) => <Icon className={className}><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></Icon>;
        const Trash2 = ({ className }) => <Icon className={className}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></Icon>;
        const LogOut = ({ className }) => <Icon className={className}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></Icon>;
        const Lock = ({ className }) => <Icon className={className}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></Icon>;
        const ShieldAlert = ({ className }) => <Icon className={className}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></Icon>;
        const Printer = ({ className }) => <Icon className={className}><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></Icon>;
        const Edit2 = ({ className }) => <Icon className={className}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></Icon>;
        const X = ({ className }) => <Icon className={className}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></Icon>;

        // --- Firebase Imports (Adicionado EmailAuthProvider e reauthenticateWithCredential) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, EmailAuthProvider, reauthenticateWithCredential } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { 
            getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, 
            onSnapshot, query, where, getDocs, writeBatch, serverTimestamp, orderBy
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAAbRqZjFI8XgPcSihtLL8OMr5snNp3ts4",
            authDomain: "serviextra-ecdc7.firebaseapp.com",
            projectId: "serviextra-ecdc7",
            storageBucket: "serviextra-ecdc7.firebasestorage.app",
            messagingSenderId: "892522606172",
            appId: "1:892522606172:web:e5393e632559ae7d404099"
        };

        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) { console.error("Erro Firebase", e); }

        const APP_ID = 'meu-registro-servicos'; 

        // --- Componente Login ---
        function LoginScreen() {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loggingIn, setLoggingIn] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError(''); setLoggingIn(true);
                try { await signInWithEmailAndPassword(auth, email, password); } 
                catch (err) { 
                    let msg = "Erro ao fazer login.";
                    if (err.code === 'auth/invalid-credential') msg = "Credenciais inválidas.";
                    setError(msg); setLoggingIn(false); 
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-gray-200 p-4">
                    <div className="bg-white p-8 rounded-xl shadow-lg w-full max-w-sm border border-gray-100">
                        <div className="text-center mb-6">
                            <div className="bg-blue-100 w-14 h-14 rounded-full flex items-center justify-center mx-auto mb-3"><Lock className="w-6 h-6 text-blue-600" /></div>
                            <h2 className="text-xl font-bold text-gray-800">Controle de Serviços</h2>
                            <p className="text-gray-500 text-sm">Acesso Restrito</p>
                        </div>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            {error && <div className="bg-red-50 text-red-600 p-3 rounded text-xs text-center">{error}</div>}
                            <input type="email" required value={email} onChange={e => setEmail(e.target.value)} className="w-full p-2 border rounded outline-none" placeholder="E-mail" />
                            <input type="password" required value={password} onChange={e => setPassword(e.target.value)} className="w-full p-2 border rounded outline-none" placeholder="Senha" />
                            <button type="submit" disabled={loggingIn} className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded disabled:opacity-70">{loggingIn ? 'Entrando...' : 'Entrar'}</button>
                        </form>
                    </div>
                </div>
            );
        }

        // --- App Principal ---
        function ServiceRegistryApp() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [permissionError, setPermissionError] = useState(false);
            const [selectedDate, setSelectedDate] = useState(new Date());
            
            // --- ABAS / TABELAS ---
            const [tables, setTables] = useState([]);
            const [activeTabId, setActiveTabId] = useState(null);
            const [editingTabId, setEditingTabId] = useState(null); 
            const [tempTabName, setTempTabName] = useState(""); 

            // Dados
            const [services, setServices] = useState([]);
            const [deposits, setDeposits] = useState([]);

            // Auth Listener
            useEffect(() => {
                return onAuthStateChanged(auth, (u) => { setUser(u); setLoading(false); });
            }, []);

            // Carregar Tabelas (Tabs)
            useEffect(() => {
                if(!user || !db) return;
                const q = query(collection(db, 'apps', APP_ID, 'users', user.uid, 'tables'), orderBy('createdAt'));
                return onSnapshot(q, (snap) => {
                    const loadedTables = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    if (loadedTables.length === 0) {
                        addDoc(collection(db, 'apps', APP_ID, 'users', user.uid, 'tables'), {
                            name: 'VICTORINO',
                            createdAt: serverTimestamp()
                        });
                    } else {
                        setTables(loadedTables);
                        if (!activeTabId) setActiveTabId(loadedTables[0].id);
                    }
                }, (err) => { if(err.code === 'permission-denied') setPermissionError(true); });
            }, [user, activeTabId]);

            const activeTabName = useMemo(() => {
                const t = tables.find(t => t.id === activeTabId);
                return t ? t.name : 'CARREGANDO...';
            }, [tables, activeTabId]);

            // Carregar Dados
            useEffect(() => {
                if(!user || !db) return;
                const qS = query(collection(db, 'apps', APP_ID, 'users', user.uid, 'services'));
                const unsubS = onSnapshot(qS, s => setServices(s.docs.map(d => ({id: d.id, ...d.data()}))));
                
                const qD = query(collection(db, 'apps', APP_ID, 'users', user.uid, 'deposits'));
                const unsubD = onSnapshot(qD, d => setDeposits(d.docs.map(d => ({id: d.id, ...d.data()}))));
                
                return () => { unsubS(); unsubD(); };
            }, [user]);

            // --- Filtragem ---
            const currentServices = useMemo(() => {
                if (!activeTabId) return [];
                const firstTableId = tables.length > 0 ? tables[0].id : null;
                
                return services.filter(s => {
                    const itemTableId = s.tableId || firstTableId;
                    if (itemTableId !== activeTabId) return false;

                    if(!s.date) return false;
                    const d = new Date(s.date + 'T12:00:00');
                    return d.getMonth() === selectedDate.getMonth() && d.getFullYear() === selectedDate.getFullYear();
                }).sort((a,b) => new Date(a.date) - new Date(b.date));
            }, [services, selectedDate, activeTabId, tables]);

            const currentDeposits = useMemo(() => {
                if (!activeTabId) return [];
                const firstTableId = tables.length > 0 ? tables[0].id : null;

                return deposits.filter(d => {
                    const itemTableId = d.tableId || firstTableId;
                    if (itemTableId !== activeTabId) return false;

                    if(!d.date) return false;
                    const date = new Date(d.date + 'T12:00:00');
                    return date.getMonth() === selectedDate.getMonth() && date.getFullYear() === selectedDate.getFullYear();
                });
            }, [deposits, selectedDate, activeTabId, tables]);

            // Totais
            const totals = useMemo(() => {
                const prog = currentServices.reduce((acc, c) => acc + (Number(c.value)||0), 0);
                const paid = currentServices.reduce((acc, c) => acc + (Number(c.paidValue)||0), 0);
                const done = currentServices.filter(s => s.status === 'CONCLUÍDO').length;
                const remaining = currentServices.length - done;
                const depTotal = currentDeposits.reduce((acc, c) => acc + (Number(c.amount)||0), 0);
                const saldo = depTotal - prog; 
                const debt = saldo < 0 ? Math.abs(saldo) : 0;
                return { prog, paid, done, remaining, depTotal, saldo, debt };
            }, [currentServices, currentDeposits]);

            // --- Gerenciamento de Abas ---
            const createNewTab = async () => {
                const name = prompt("Nome da nova tabela (ex: MACHADO):");
                if (name && name.trim()) {
                    try {
                        const docRef = await addDoc(collection(db, 'apps', APP_ID, 'users', user.uid, 'tables'), {
                            name: name.trim().toUpperCase(),
                            createdAt: serverTimestamp()
                        });
                        setActiveTabId(docRef.id);
                    } catch(e) { alert("Erro ao criar tabela."); }
                }
            };

            // --- Função de Excluir Aba com Senha do ADMIN ---
            const deleteTab = async (tabId, tabName) => {
                if (tables.length <= 1) {
                    alert("Não é possível excluir a última tabela.");
                    return;
                }
                const pwd = prompt(`Digite sua SENHA DE LOGIN para confirmar a exclusão da tabela "${tabName}":`);
                if (!pwd) return;

                try {
                    // Reautentica para verificar a senha
                    const credential = EmailAuthProvider.credential(user.email, pwd);
                    await reauthenticateWithCredential(user, credential);
                    
                    // Se a senha estiver correta, pede confirmação final
                    if (!confirm(`Senha correta. Tem certeza absoluta? Todos os dados da tabela "${tabName}" serão PERDIDOS.`)) return;

                    const batch = writeBatch(db);
                    
                    // Deleta tabela
                    batch.delete(doc(db, 'apps', APP_ID, 'users', user.uid, 'tables', tabId));
                    
                    // Deleta serviços associados
                    const qs = services.filter(s => s.tableId === tabId);
                    qs.forEach(s => batch.delete(doc(db, 'apps', APP_ID, 'users', user.uid, 'services', s.id)));

                    // Deleta depósitos associados
                    const qd = deposits.filter(d => d.tableId === tabId);
                    qd.forEach(d => batch.delete(doc(db, 'apps', APP_ID, 'users', user.uid, 'deposits', d.id)));

                    await batch.commit();
                    
                    if (activeTabId === tabId) {
                        setActiveTabId(tables.find(t => t.id !== tabId)?.id);
                    }
                    alert("Tabela excluída com sucesso.");

                } catch(e) { 
                    console.error(e); 
                    if (e.code === 'auth/invalid-credential' || e.code === 'auth/wrong-password' || e.code === 'auth/invalid-login-credentials') {
                        alert("Senha incorreta.");
                    } else {
                        alert("Erro ao excluir: " + e.message); 
                    }
                }
            };

            const startEditingTab = (tab) => { setEditingTabId(tab.id); setTempTabName(tab.name); };
            const saveTabName = async () => {
                if (tempTabName && tempTabName.trim()) {
                    await updateDoc(doc(db, 'apps', APP_ID, 'users', user.uid, 'tables', editingTabId), { name: tempTabName.trim().toUpperCase() });
                }
                setEditingTabId(null);
            };

            // --- Saldo Automático ---
            useEffect(() => {
                if (!user || loading || !activeTabId || tables.length === 0) return;
                const checkBalance = async () => {
                    const prevDate = new Date(selectedDate);
                    prevDate.setMonth(selectedDate.getMonth() - 1);
                    const firstTableId = tables[0].id;

                    const pServices = services.filter(s => {
                        const tid = s.tableId || firstTableId;
                        if (tid !== activeTabId) return false;
                        const d = new Date(s.date + 'T12:00:00');
                        return d.getMonth() === prevDate.getMonth() && d.getFullYear() === prevDate.getFullYear();
                    });
                    const pDeposits = deposits.filter(d => {
                        const tid = d.tableId || firstTableId;
                        if (tid !== activeTabId) return false;
                        const dDate = new Date(d.date + 'T12:00:00');
                        return dDate.getMonth() === prevDate.getMonth() && dDate.getFullYear() === prevDate.getFullYear();
                    });

                    if (pServices.length === 0 && pDeposits.length === 0) return;

                    const pPaid = pServices.reduce((acc, c) => acc + (Number(c.paidValue)||0), 0);
                    const pDepTotal = pDeposits.reduce((acc, c) => acc + (Number(c.amount)||0), 0);
                    const prevBalance = Math.round((pDepTotal - pPaid) * 100) / 100;

                    const prevMonthName = prevDate.toLocaleDateString('pt-BR', { month: 'long' }).toUpperCase();
                    const expectedDesc = `SALDO MÊS DE ${prevMonthName}`;
                    
                    const existingEntry = currentDeposits.find(d => d.description === expectedDesc || d.type === 'balance_carryover');

                    try {
                        if (existingEntry) {
                            if (Math.abs((existingEntry.amount || 0) - prevBalance) > 0.01) {
                                await updateDoc(doc(db, 'apps', APP_ID, 'users', user.uid, 'deposits', existingEntry.id), {
                                    amount: prevBalance, description: expectedDesc, type: 'balance_carryover'
                                });
                            }
                        } else {
                            const newDateStr = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), 1, 12).toISOString().split('T')[0];
                            await addDoc(collection(db, 'apps', APP_ID, 'users', user.uid, 'deposits'), {
                                date: newDateStr, amount: prevBalance, description: expectedDesc, type: 'balance_carryover', tableId: activeTabId, createdAt: serverTimestamp()
                            });
                        }
                    } catch (e) {}
                };
                checkBalance();
            }, [selectedDate, services, deposits, activeTabId, tables]);

            // CRUD Ações
            const handleLogout = () => confirm("Sair?") && signOut(auth);
            const handlePrint = () => window.print();
            const changeMonth = (o) => { const d = new Date(selectedDate); d.setMonth(d.getMonth() + o); setSelectedDate(d); };
            
            const addService = async () => {
                if (!activeTabId) return;
                const today = new Date();
                let d = today.toISOString().split('T')[0];
                if(today.getMonth() !== selectedDate.getMonth()) { d = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), 1, 12).toISOString().split('T')[0]; }
                await addDoc(collection(db, 'apps', APP_ID, 'users', user.uid, 'services'), { 
                    date: d, value: 0, paidValue: 0, status: 'PENDENTE', tableId: activeTabId, createdAt: serverTimestamp() 
                });
            };
            const updService = (id, f, v) => updateDoc(doc(db, 'apps', APP_ID, 'users', user.uid, 'services', id), {[f]:v});
            const delService = (id) => confirm("Excluir?") && deleteDoc(doc(db, 'apps', APP_ID, 'users', user.uid, 'services', id));

            const addDeposit = async () => {
                if (!activeTabId) return;
                const d = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), 1, 12).toISOString().split('T')[0]; 
                await addDoc(collection(db, 'apps', APP_ID, 'users', user.uid, 'deposits'), { 
                    date: d, amount: 0, tableId: activeTabId, createdAt: serverTimestamp() 
                });
            };
            const updDeposit = (id, f, v) => updateDoc(doc(db, 'apps', APP_ID, 'users', user.uid, 'deposits', id), {[f]:v});
            const delDeposit = (id) => confirm("Excluir?") && deleteDoc(doc(db, 'apps', APP_ID, 'users', user.uid, 'deposits', id));

            const format = (v) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v);
            const getDay = (ds) => ds ? ['DOMINGO','SEGUNDA','TERÇA','QUARTA','QUINTA','SEXTA','SÁBADO'][new Date(ds+'T12:00:00').getDay()] : '-';

            // Cores
            const hY = "bg-[#FFE699]"; const hB = "bg-[#D9E1F2]"; const cC = "bg-[#00B0F0]"; const cB = "text-[#0070C0]"; const sY = "bg-[#FFFF00]"; const sG = "bg-[#D9D9D9]";

            if (loading) return <div className="flex items-center justify-center h-screen bg-gray-50 text-gray-500">Carregando...</div>;
            if (!user) return <LoginScreen />;
            if (permissionError) return <div className="p-8 text-center text-red-600 font-bold">Erro de Permissão. Verifique o Console Firebase.</div>;

            return (
                <div className="min-h-screen bg-gray-100 p-2 md:p-4 font-sans text-sm md:text-base">
                    
                    {/* --- BARRA DE ABAS (Tabelas) --- */}
                    <div className="max-w-7xl mx-auto mb-4 no-print">
                        <div className="flex items-center gap-2 overflow-x-auto scrollbar-hide pb-2">
                            {tables.map(tab => (
                                <div 
                                    key={tab.id}
                                    className={`
                                        group flex items-center gap-2 px-4 py-2 rounded-t-lg border-b-2 cursor-pointer transition-all min-w-fit relative
                                        ${activeTabId === tab.id ? 'bg-white border-blue-600 text-blue-600 font-bold shadow-sm' : 'bg-gray-200 border-transparent text-gray-500 hover:bg-gray-300'}
                                    `}
                                    onClick={() => setActiveTabId(tab.id)}
                                >
                                    {editingTabId === tab.id ? (
                                        <input 
                                            autoFocus
                                            type="text" 
                                            value={tempTabName} 
                                            onChange={(e) => setTempTabName(e.target.value)}
                                            onBlur={saveTabName}
                                            onKeyDown={(e) => e.key === 'Enter' && saveTabName()}
                                            className="bg-white border border-blue-400 rounded px-1 text-xs uppercase w-24"
                                        />
                                    ) : (
                                        <span onDoubleClick={() => startEditingTab(tab)} title="Clique duplo para renomear">{tab.name}</span>
                                    )}
                                    
                                    {/* Ícone de Edição */}
                                    {activeTabId === tab.id && !editingTabId && (
                                        <button onClick={(e) => { e.stopPropagation(); startEditingTab(tab); }} className="text-blue-400 hover:text-blue-800" title="Renomear">
                                            <Edit2 className="w-3 h-3" />
                                        </button>
                                    )}

                                    {/* Botão de Excluir (X) - Com Senha */}
                                    {!editingTabId && (
                                        <button 
                                            onClick={(e) => { e.stopPropagation(); deleteTab(tab.id, tab.name); }} 
                                            className="text-gray-400 hover:text-red-600 ml-1 opacity-0 group-hover:opacity-100 transition-opacity"
                                            title="Excluir Tabela (Requer Senha)"
                                        >
                                            <X className="w-3 h-3" />
                                        </button>
                                    )}
                                </div>
                            ))}
                            <button onClick={createNewTab} className="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg text-gray-600 font-bold transition-colors" title="Nova Tabela">+</button>
                        </div>
                    </div>

                    {/* Header */}
                    <div className="max-w-7xl mx-auto mb-6 flex flex-col md:flex-row justify-between items-center gap-4 bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                        <h1 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                            <CalendarIcon className="w-6 h-6 text-blue-600" /> Registro de Serviços
                        </h1>
                        <div className="flex items-center gap-4 bg-gray-50 p-2 rounded-lg border border-gray-200 no-print">
                            <button onClick={() => changeMonth(-1)} className="p-2 hover:bg-gray-200 rounded-full transition-colors"><ChevronLeft className="w-5 h-5 text-gray-600" /></button>
                            <div className="text-lg font-bold text-gray-800 w-40 text-center uppercase">{selectedDate.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' })}</div>
                            <button onClick={() => changeMonth(1)} className="p-2 hover:bg-gray-200 rounded-full transition-colors"><ChevronRight className="w-5 h-5 text-gray-600" /></button>
                        </div>
                        <div className="flex gap-2 no-print">
                            <button onClick={handlePrint} className="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 font-medium shadow-sm"><Printer className="w-4 h-4" /> Gerar Relatório</button>
                            <button onClick={addService} className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 font-medium shadow-sm"><Plus className="w-4 h-4" /> Novo Serviço</button>
                            <button onClick={handleLogout} className="bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-2 rounded-lg shadow-sm" title="Sair"><LogOut className="w-4 h-4" /></button>
                        </div>
                        <div className="hidden print:block text-2xl font-bold uppercase text-center mb-6">{selectedDate.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' })}</div>
                    </div>

                    {/* Grid Principal */}
                    <div className="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-4 gap-6">
                        
                        {/* Sidebar */}
                        <div className="flex flex-col gap-6 order-2 lg:order-1">
                            <div className="bg-white p-4 rounded-lg shadow-sm border border-gray-200 print-break-inside-avoid">
                                <h3 className="text-sm font-bold text-gray-500 mb-3 uppercase tracking-wider border-b pb-2">Resumo Financeiro</h3>
                                <div className="border border-gray-800 text-center font-bold text-sm">
                                    <div className="grid grid-cols-2 border-b border-gray-800"><div className={`${sY} p-2 border-r border-gray-800 flex items-center justify-center`}>SERV. PROGRAMADOS</div><div className={`${sG} p-2 flex items-center justify-center text-lg`}>{format(totals.prog)}</div></div>
                                    <div className="grid grid-cols-2 border-b border-gray-800"><div className={`${sY} p-2 border-r border-gray-800 flex items-center justify-center`}>TOTAL PAGO</div><div className={`${sG} p-2 flex items-center justify-center text-lg`}>{format(totals.depTotal)}</div></div>
                                    <div className="grid grid-cols-2 border-b border-gray-800"><div className={`${sY} p-2 border-r border-gray-800 flex items-center justify-center`}>CONCLUÍDOS</div><div className={`${sG} p-2 flex items-center justify-center text-lg`}>{totals.done}</div></div>
                                    <div className="grid grid-cols-2 border-b border-gray-800"><div className={`${sY} p-2 border-r border-gray-800 flex items-center justify-center`}>SERVIÇOS RESTANTES</div><div className={`${sG} p-2 flex items-center justify-center text-lg`}>{totals.remaining}</div></div>
                                    
                                    <div className="grid grid-cols-2 border-b border-gray-800">
                                        <div className={`${sY} p-2 border-r border-gray-800 flex flex-col items-center justify-center leading-tight`}><span>SALDO</span><span className="text-[10px] font-normal">CRÉDITO</span></div>
                                        <div className={`${sG} p-2 flex items-center justify-center text-lg text-gray-800`}>{format(totals.saldo)}</div>
                                    </div>
                                    <div className="grid grid-cols-2">
                                        <div className={`${sY} p-2 border-r border-gray-800 flex items-center justify-center`}>A PAGAR</div>
                                        <div className={`${sG} p-2 flex items-center justify-center text-lg ${totals.saldo < 0 ? 'text-red-600' : 'text-gray-800'}`}>{format(totals.debt)}</div>
                                    </div>
                                </div>
                            </div>

                            <div className="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden print-break-inside-avoid">
                                <div className="flex justify-between items-center p-3 bg-gray-50 border-b border-gray-200">
                                    <h3 className="font-bold text-gray-700 text-sm uppercase">Depósitos</h3>
                                    <button onClick={addDeposit} className="text-blue-600 hover:text-blue-800 no-print"><Plus className="w-4 h-4" /></button>
                                </div>
                                <table className="w-full text-sm">
                                    <thead className="bg-yellow-100 text-yellow-800 font-bold"><tr><th className="p-2 text-left">Data / Desc</th><th className="p-2 text-right">Valor</th><th className="w-6 no-print"></th></tr></thead>
                                    <tbody className="divide-y divide-gray-100">
                                        {currentDeposits.map(d => (
                                            <tr key={d.id} className="hover:bg-gray-50">
                                                <td className="p-2">
                                                    <input type="text" value={d.description||''} onChange={e=>updDeposit(d.id,'description',e.target.value)} placeholder="Desc." className="w-full bg-transparent font-bold uppercase text-xs mb-1 outline-none" />
                                                    <input type="date" value={d.date} onChange={e=>updDeposit(d.id,'date',e.target.value)} className="w-full bg-transparent text-gray-500 text-xs outline-none" />
                                                </td>
                                                <td className="p-2 text-right font-bold text-green-700 align-top">
                                                    <div className="flex justify-end gap-1"><span className="text-xs text-gray-400">R$</span>
                                                    <input type="number" step="0.01" value={Math.round((d.amount||0)*100)/100} onChange={e=>updDeposit(d.id,'amount',parseFloat(e.target.value))} className="w-16 text-right bg-transparent outline-none" />
                                                    </div>
                                                </td>
                                                <td className="p-2 align-top no-print"><button onClick={()=>delDeposit(d.id)} className="text-gray-400 hover:text-red-500"><Trash2 className="w-3 h-3" /></button></td>
                                            </tr>
                                        ))}
                                    </tbody>
                                    <tfoot className="bg-gray-50 font-bold text-gray-700 text-xs"><tr><td className="p-2 text-right">TOTAL:</td><td className="p-2 text-right">{format(totals.depTotal)}</td><td className="no-print"></td></tr></tfoot>
                                </table>
                            </div>
                        </div>

                        {/* Tabela Principal */}
                        <div className="lg:col-span-3 bg-white rounded-lg shadow-sm overflow-hidden border border-gray-300 order-1 lg:order-2">
                            <div className="overflow-x-auto">
                                <table className="w-full border-collapse min-w-[800px]">
                                    <thead>
                                        <tr>
                                            {/* AJUSTE: COLUNA 1 COM "SERVIÇOS" ACIMA DO NUMERO E REMOÇÃO DE "DIAS" */}
                                            <th className={`border border-gray-400 p-2 w-24 text-center font-bold ${hY}`}>
                                                <div className="flex flex-col items-center justify-center leading-none">
                                                    <span className="text-[10px] mb-1">SERVIÇOS</span>
                                                    <span className="text-xl">{currentServices.length}</span>
                                                    {/* DIAS removido aqui */}
                                                </div>
                                            </th>
                                            {/* AJUSTE: COLUNA 2 APENAS "SEMANA" */}
                                            <th className={`border border-gray-400 p-2 text-center font-bold ${hY}`}>SEMANA</th>
                                            <th colSpan="6" className={`border border-gray-400 p-2 text-center font-bold ${hB} text-lg uppercase`}>CONTROLE MENSAL - {activeTabName}</th>
                                        </tr>
                                        <tr className="text-xs md:text-sm uppercase bg-[#E2EFDA]">
                                            <th className="border border-gray-400 p-2 w-32">STATUS</th>
                                            <th className="border border-gray-400 p-2 w-32">DATA</th>
                                            <th className="border border-gray-400 p-2 w-28">DIA</th>
                                            <th className="border border-gray-400 p-2 w-32">VALOR (R$)</th>
                                            <th className="border border-gray-400 p-2 w-32">A PAGAR</th>
                                            <th className="border border-gray-400 p-2 w-32">PAGO</th>
                                            <th className="border border-gray-400 p-2 w-24">CONDIÇÃO</th>
                                            <th className="border border-gray-400 p-2 w-10 no-print"></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {currentServices.map(s => {
                                            const toPay = (Number(s.value)||0) - (Number(s.paidValue)||0);
                                            const isOk = s.status === 'CONCLUÍDO';
                                            return (
                                                <tr key={s.id} className="hover:bg-gray-50 text-sm font-medium">
                                                    <td className="border border-gray-300 p-0">
                                                        <button onClick={()=>updService(s.id,'status',s.status==='CONCLUÍDO'?'PENDENTE':'CONCLUÍDO')} className={`w-full h-full p-2 text-white font-bold uppercase text-xs ${s.status==='CONCLUÍDO'?cC:'bg-gray-400'}`}>{s.status||'PENDENTE'}</button>
                                                    </td>
                                                    <td className="border border-gray-300 p-1"><input type="date" value={s.date} onChange={e=>updService(s.id,'date',e.target.value)} className="w-full text-center font-bold uppercase bg-transparent outline-none" /></td>
                                                    <td className="border border-gray-300 p-2 text-center uppercase text-gray-700 font-bold bg-gray-50">{getDay(s.date)}</td>
                                                    <td className="border border-gray-300 p-1"><div className="flex px-2"><span className="text-gray-500 mr-1">R$</span><input type="number" step="0.01" value={s.value} onChange={e=>updService(s.id,'value',parseFloat(e.target.value))} className="w-full font-bold text-gray-800 outline-none" /></div></td>
                                                    <td className="border border-gray-300 p-2 text-center font-bold text-red-500 bg-gray-50">{toPay>0?format(toPay):<span className="text-gray-400">R$ -</span>}</td>
                                                    <td className="border border-gray-300 p-1"><div className="flex px-2"><span className="text-gray-500 mr-1">R$</span><input type="number" step="0.01" value={s.paidValue} onChange={e=>updService(s.id,'paidValue',parseFloat(e.target.value))} className={`w-full font-bold ${cB} outline-none`} /></div></td>
                                                    <td className="border border-gray-300 p-0 align-middle"><div className={`h-full flex items-center justify-center font-bold text-xs p-2 ${isOk ? cC+' text-white' : 'bg-yellow-100 text-yellow-700'}`}>{isOk ? 'OK' : 'ABERTO'}</div></td>
                                                    <td className="border border-gray-300 p-0 text-center no-print"><button onClick={()=>delService(s.id)} className="p-2 text-red-400 hover:text-red-600 hover:bg-red-50 w-full h-full flex items-center justify-center"><Trash2 className="w-4 h-4" /></button></td>
                                                </tr>
                                            );
                                        })}
                                        {currentServices.length===0 && <tr><td colSpan="8" className="p-8 text-center text-gray-400">Nenhum serviço registrado nesta tabela para este mês.</td></tr>}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div className="text-center text-xs text-gray-400 mt-8 pb-4 no-print">Dados salvos automaticamente no Firebase.</div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ServiceRegistryApp />);
    </script>
</body>
</html>
